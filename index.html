<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Appalti IA ANAC 2023-2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body data-bs-spy="scroll" data-bs-target="#mainNav">
    <!-- Navbar -->
    <nav id="mainNav" class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#top"><i class="bi bi-cpu"></i> Appalti IA</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#kpi"><i class="bi bi-speedometer2"></i> KPI</a></li>
                    <li class="nav-item"><a class="nav-link" href="#top-pa"><i class="bi bi-building"></i> Top PA</a></li>
                    <li class="nav-item"><a class="nav-link" href="#categorie"><i class="bi bi-pie-chart"></i> Categorie</a></li>
                    <li class="nav-item"><a class="nav-link" href="#settori"><i class="bi bi-diagram-3"></i> Settori</a></li>
                    <li class="nav-item"><a class="nav-link" href="#pnrr"><i class="bi bi-flag"></i> PNRR</a></li>
                    <li class="nav-item"><a class="nav-link" href="#trend"><i class="bi bi-graph-up"></i> Trend</a></li>
                    <li class="nav-item"><a class="nav-link" href="#classifica"><i class="bi bi-table"></i> Classifica</a></li>
                    <li class="nav-item"><a class="nav-link" href="#ricerca"><i class="bi bi-search"></i> Ricerca</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="top" class="header-section scroll-margin">
        <div class="container">
            <h1 class="mb-2"><i class="bi bi-cpu"></i> Dashboard Appalti Intelligenza Artificiale</h1>
            <p class="mb-0 opacity-75">Analisi contratti pubblici ANAC | Periodo 2023-2025 | Ultimo aggiornamento: 28/01/2026</p>
        </div>
    </div>

    <div class="container">
        <!-- Ricerca -->
        <section id="ricerca" class="scroll-margin mb-4">
            <div class="search-section">
                <h5 class="mb-3"><i class="bi bi-search"></i> Ricerca Contratti</h5>
                <p class="text-muted mb-3">Cerca tra 959 contratti per CIG, PA, oggetto, provincia, categoria o settore. Digita almeno 3 caratteri.</p>
                <div class="search-input-wrapper">
                    <input type="text" id="searchInput" class="form-control search-input" placeholder="Cerca contratti (es: ROMA, cybersecurity, ASL, B04...)" autocomplete="off">
                    <i class="bi bi-search search-icon"></i>
                    <div id="autocomplete" class="autocomplete-dropdown"></div>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>
        </section>

        <!-- KPI Cards -->
        <section id="kpi" class="scroll-margin">
            <div class="row g-3 mb-4">
                <div class="col-6 col-md-4 col-lg-2">
                    <div class="card kpi-card bg-primary text-white h-100"><div class="card-body text-center"><div class="kpi-value">959</div><div class="kpi-label">Contratti</div></div></div>
                </div>
                <div class="col-6 col-md-4 col-lg-2">
                    <div class="card kpi-card bg-success text-white h-100"><div class="card-body text-center"><div class="kpi-value">175.5M</div><div class="kpi-label">Valore Totale</div></div></div>
                </div>
                <div class="col-6 col-md-4 col-lg-2">
                    <div class="card kpi-card bg-info text-white h-100"><div class="card-body text-center"><div class="kpi-value">592</div><div class="kpi-label">PA Coinvolte</div></div></div>
                </div>
                <div class="col-6 col-md-4 col-lg-2">
                    <div class="card kpi-card bg-warning text-dark h-100"><div class="card-body text-center"><div class="kpi-value">183K</div><div class="kpi-label">Valore Medio</div></div></div>
                </div>
                <div class="col-6 col-md-4 col-lg-2">
                    <div class="card kpi-card bg-success text-white h-100"><div class="card-body text-center"><div class="kpi-value">256</div><div class="kpi-label">PNRR (26.7%)</div></div></div>
                </div>
                <div class="col-6 col-md-4 col-lg-2">
                    <div class="card kpi-card bg-secondary text-white h-100"><div class="card-body text-center"><div class="kpi-value">96</div><div class="kpi-label">Province</div></div></div>
                </div>
            </div>
        </section>

        <!-- Top 10 PA -->
        <section id="top-pa" class="scroll-margin">
            <div class="chart-container">
                <h5 class="mb-3"><i class="bi bi-building"></i> Top 10 Amministrazioni per Spesa</h5>
                <div style="height: 400px;"><canvas id="chartTop10"></canvas></div>
            </div>
        </section>

        <!-- Categorie e Settori -->
        <div class="row">
            <div class="col-lg-6">
                <section id="categorie" class="scroll-margin">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="bi bi-pie-chart"></i> Distribuzione per Categoria AI</h5>
                        <div style="height: 350px;"><canvas id="chartCategorie"></canvas></div>
                    </div>
                </section>
            </div>
            <div class="col-lg-6">
                <section id="settori" class="scroll-margin">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="bi bi-diagram-3"></i> Distribuzione per Settore PA</h5>
                        <div style="height: 350px;"><canvas id="chartSettori"></canvas></div>
                    </div>
                </section>
            </div>
        </div>

        <!-- PNRR e Trend -->
        <div class="row">
            <div class="col-lg-4">
                <section id="pnrr" class="scroll-margin">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="bi bi-flag"></i> PNRR vs Non-PNRR</h5>
                        <div style="height: 300px;"><canvas id="chartPnrr"></canvas></div>
                    </div>
                </section>
            </div>
            <div class="col-lg-8">
                <section id="trend" class="scroll-margin">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="bi bi-graph-up"></i> Trend Temporale</h5>
                        <div style="height: 300px;"><canvas id="chartTrend"></canvas></div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Tabella Top 30 PA -->
        <section id="classifica" class="scroll-margin">
            <div class="table-container">
                <h5 class="mb-3"><i class="bi bi-table"></i> Top 30 Amministrazioni Appaltanti</h5>
                <div class="mb-3" id="settoreFilters">
                    <span class="text-muted me-2"><i class="bi bi-funnel"></i> Filtra per settore:</span>
                    <button class="btn btn-sm btn-primary me-1 mb-1 filter-btn active" data-settore="all">Tutti</button>
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1 filter-btn" data-settore="PA Centrale">PA Centrale</button>
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1 filter-btn" data-settore="PA Locale">PA Locale</button>
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1 filter-btn" data-settore="Sanità">Sanità</button>
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1 filter-btn" data-settore="Università e Ricerca">Università</button>
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1 filter-btn" data-settore="Istruzione">Istruzione</button>
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1 filter-btn" data-settore="Difesa e Sicurezza">Difesa</button>
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1 filter-btn" data-settore="Giustizia">Giustizia</button>
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1 filter-btn" data-settore="Utilities & Trasporti">Utilities</button>
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1 filter-btn" data-settore="Enti Pubblici Economici">Enti Economici</button>
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1 filter-btn" data-settore="Altri Enti Pubblici">Altri Enti</button>
                </div>
                <div id="filterInfo" class="text-muted small mb-2" style="display:none;"></div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="paTable">
                        <thead class="table-dark">
                            <tr><th>#</th><th>Amministrazione</th><th>Provincia</th><th>Settore</th><th class="text-end">Spesa Totale</th><th class="text-end">N. Contr.</th><th class="text-end">Media</th></tr>
                        </thead>
                        <tbody id="paTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Validazioni -->
        <div class="alert-section">
            <h5 class="mb-3"><i class="bi bi-shield-check"></i> Validazioni e Anomalie</h5>
            <div class="alert alert-danger d-flex align-items-start" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                <div><strong>Errore Critico Corretto</strong><br>CIG <code>B1B36B1A1E</code> - Importo errato €293,893,058.00 corretto a €357.85<br><small class="text-muted">Acquisto libri biblioteca (confronto CIG B1AA21EEA3, B1B748D667)</small></div>
            </div>
            <div class="alert alert-warning d-flex align-items-start" role="alert">
                <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                <div><strong>Analisi Aggiudicatari Non Disponibile</strong><br>I dati ANAC non contengono informazioni sulle società aggiudicatarie.</div>
            </div>
        </div>
    </div>

    <!-- Modal PA Contracts -->
    <div class="modal fade" id="paModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paModalLabel">Contratti</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modal-body-scroll" id="paContractsList"></div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p class="mb-1">Dashboard Appalti Intelligenza Artificiale - Dati ANAC 2023-2025</p>
            <small class="opacity-75">Elaborazione automatica con categorizzazione AI e identificazione PNRR</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Generate Top 30 table dynamically after data loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (typeof contractsData !== 'undefined' && contractsData.length > 0) {
                    const byPA = {};
                    contractsData.forEach(c => {
                        const pa = c.DENOMINAZIONE_AMMINISTRAZIONE || 'N/D';
                        if (!byPA[pa]) byPA[pa] = { total: 0, count: 0, provincia: c.COD_ISTAT_PROVINCIA_SEDE || 'N/D', settore: c.settore_pa || 'Altri Enti Pubblici' };
                        byPA[pa].total += parseFloat(c.IMPORTO_COMPLESSIVO_GARA) || 0;
                        byPA[pa].count++;
                    });
                    const top30 = Object.entries(byPA).sort((a, b) => b[1].total - a[1].total).slice(0, 30);
                    document.getElementById('paTableBody').innerHTML = top30.map(([pa, data], i) =>
                        `<tr data-settore="${data.settore}" data-pa="${pa}"><td>${i + 1}</td><td><span class="pa-link" onclick="showPAContracts(this)">${pa.length > 50 ? pa.substring(0, 47) + '...' : pa}</span></td><td>${data.provincia}</td><td><span class="badge bg-secondary badge-settore">${data.settore}</span></td><td class="text-end fw-bold">${Math.round(data.total).toLocaleString('it-IT')}</td><td class="text-end">${data.count}</td><td class="text-end">${Math.round(data.total / data.count).toLocaleString('it-IT')}</td></tr>`
                    ).join('');
                }
            }, 500);
        });
    </script>
</body>
</html>
